{% extends "form.html" %}
{% load comisiones_extras %}

{% block title %}Registrar pago{% endblock %}

{% block back_link %}
  <section class="filter-container">
    <div class="filter-title">Registrar pago – {{ mes_nombre }} {{ anio }}</div>
    <a href="{{ back_url }}" class="btn-filter btn-volver">Volver</a>
  </section>
{% endblock %}

{% block extra_actions %}
  {% if pago %}
    <button type="submit" class="btn-delete" formaction="{% url 'comisiones_eliminar_pago' pago.id %}" formmethod="post" onclick="return confirm('¿Eliminar este pago?');">Eliminar</button>
  {% endif %}
{% endblock %}

{% block form_fields %}
  <input type="hidden" name="next" value="{{ back_url }}">
  <input type="hidden" name="mes" value="{{ mes }}">
  <input type="hidden" name="anio" value="{{ anio }}">

  <div class="form-grid">
    <div class="form-col">
      {% if comisionista %}
        <div class="fixed-center">{{ comisionista.nombre }}</div>
      {% endif %}

      <label for="{{ form.comision.id_for_label }}">Pago comisión</label>
      {{ form.comision }}
      {% if not form.comision.field.queryset %}
        <div class="fixed-center">No hay comisiones pendientes para este periodo.</div>
      {% endif %}

      <label for="{{ form.fecha_pago.id_for_label }}">Fecha de pago</label>
      {{ form.fecha_pago }}

      <label for="{{ form.monto.id_for_label }}">Monto</label>
      <div class="input-currency" style="display:none">{{ form.monto }}</div>
      <div class="input-currency">
        <input type="text" id="monto_display" readonly style="text-align:left;">
      </div>

      <label for="{{ form.comentario.id_for_label }}">Comentario</label>
      {{ form.comentario|default_if_none:"" }}
    </div>
  </div>
  <script>
    (function () {
      const select = document.getElementById("{{ form.comision.id_for_label }}");
      const montoInput = document.getElementById("{{ form.monto.id_for_label }}");
      const montoDisplay = document.getElementById("monto_display");
      if (!select || !montoInput || !montoDisplay) return;
      const amounts = {
        {% for c in form.fields.comision.queryset %}
          "{{ c.pk }}": "{{ c.monto }}",
        {% endfor %}
      };
      const formatter = new Intl.NumberFormat("es-MX", { style: "currency", currency: "MXN" });
      function updateMonto() {
        const val = select.value;
        const raw = val && amounts[val] ? amounts[val] : "";
        montoInput.value = raw;
        montoDisplay.value = raw ? formatter.format(Number(raw)) : "";
      }
      select.addEventListener("change", updateMonto);
      updateMonto();
    })();
  </script>
{% endblock %}
