{% extends "form.html" %}

{% block title %}Nuevo Cliente{% endblock %}

{% block form_container_classes %}clientes-form{% endblock %}

{% block back_link %}
  <div class="filter-container">
    <a href="{{ back_url }}" class="btn-filter btn-volver">Volver</a>
  </div>
{% endblock %}

{% block form_fields %}
  {% if form.instance.pk %}
    <div class="form-meta">
      <strong>Fecha de registro:</strong>
      {% if form.fecha_registro_display %}
        {{ form.fecha_registro_display|date:"d/m/Y H:i" }}
      {% elif form.instance.fecha_registro %}
        {{ form.instance.fecha_registro|date:"d/m/Y H:i" }}
      {% endif %}
    </div>
  {% endif %}

  <div class="form-grid">
    <div class="form-col">
      <label for="{{ form.cliente.id_for_label }}">{{ form.cliente.label }}</label>
      {{ form.cliente }}
      {% if form.cliente.errors %}<div class="error">{{ form.cliente.errors }}</div>{% endif %}

      <label for="{{ form.servicio.id_for_label }}">{{ form.servicio.label }}</label>
      {{ form.servicio }}
      {% if form.servicio.errors %}<div class="error">{{ form.servicio.errors }}</div>{% endif %}

      <label for="{{ form.giro.id_for_label }}">{{ form.giro.label }}</label>
      {{ form.giro }}
      {% if form.giro.errors %}<div class="error">{{ form.giro.errors }}</div>{% endif %}

      <label for="{{ form.tipo.id_for_label }}">{{ form.tipo.label }}</label>
      {{ form.tipo }}
      {% if form.tipo.errors %}<div class="error">{{ form.tipo.errors }}</div>{% endif %}

      <label for="{{ form.medio.id_for_label }}">{{ form.medio.label }}</label>
      {{ form.medio }}
      {% if form.medio.errors %}<div class="error">{{ form.medio.errors }}</div>{% endif %}
    </div>

    <div class="form-col">
      <label for="{{ form.contacto.id_for_label }}">{{ form.contacto.label }}</label>
      {{ form.contacto }}
      {% if form.contacto.errors %}<div class="error">{{ form.contacto.errors }}</div>{% endif %}

      <label for="{{ form.telefono.id_for_label }}">{{ form.telefono.label }}</label>
      {{ form.telefono }}
      {% if form.telefono.errors %}<div class="error">{{ form.telefono.errors }}</div>{% endif %}

      <label for="{{ form.correo.id_for_label }}">{{ form.correo.label }}</label>
      {{ form.correo }}
      {% if form.correo.errors %}<div class="error">{{ form.correo.errors }}</div>{% endif %}

      <label for="{{ form.conexion.id_for_label }}">{{ form.conexion.label }}</label>
      {{ form.conexion }}
      {% if form.conexion.errors %}<div class="error">{{ form.conexion.errors }}</div>{% endif %}
    </div>

    <div class="form-col">
      {% for comisionista_field, comision_field in comisiones %}
        <label for="{{ comisionista_field.id_for_label }}">{{ comisionista_field.label }}</label>
        {{ comisionista_field }}
        {% if comisionista_field.errors %}<div class="error">{{ comisionista_field.errors }}</div>{% endif %}
      {% endfor %}
    </div>

    <div class="form-col">
      {% for comisionista_field, comision_field in comisiones %}
        <label for="{{ comision_field.id_for_label }}">{{ comision_field.label }}</label>
        {{ comision_field }}
        {% if comision_field.errors %}<div class="error">{{ comision_field.errors }}</div>{% endif %}
      {% endfor %}
    </div>
  </div>

  <input type="hidden" name="next" value="{{ back_url }}" />
{% endblock %}

{% block extra_actions %}
  {% if form.instance.pk %}
    <input type="hidden" name="next" value="{{ back_url }}" />
    <button type="submit"
            class="btn-delete"
            formmethod="post"
            formnovalidate
            formaction="{% url 'eliminar_cliente' form.instance.pk %}">
      Eliminar
    </button>
  {% endif %}
  <script>
    (function() {
      function confirmarComision(event) {
        const formEl = document.querySelector('.form-container form');
        if (!formEl) return true;
        const razon = (formEl.querySelector('#id_cliente')?.value || 'este cliente').trim();
        const comisionInputs = formEl.querySelectorAll('input[name^="comision_"]');
        let total = 0;
        comisionInputs.forEach((input) => {
          const val = parseFloat(input.value);
          if (!isNaN(val)) {
            total += val;
          }
        });
        const mensaje = `¿Estás seguro que deseas guardar el cliente "${razon}" con ${total.toFixed(2)}% de comisión?`;
        const ok = confirm(mensaje);
        if (!ok && event) {
          event.preventDefault();
        }
        return ok;
      }

      document.addEventListener('DOMContentLoaded', () => {
        const formEl = document.querySelector('.form-container form');
        if (formEl) {
          formEl.addEventListener('submit', (ev) => confirmarComision(ev));
        }
      });
    })();
  </script>
{% endblock %}
