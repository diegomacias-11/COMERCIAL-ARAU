{% extends "form.html" %}

{% block form_container_classes %}dispersiones-form{% endblock %}

{% block title %}{% if venta %}Editar Venta{% else %}Nueva Venta{% endif %}{% endblock %}

{% block back_link %}
  <section class="filter-container">
    <a href="{{ back_url }}" class="btn-filter btn-volver">Volver</a>
  </section>
{% endblock %}

{% block form_fields %}
  <input type="hidden" name="next" value="{{ back_url }}">
  <input type="hidden" name="mes" value="{{ mes }}">
  <input type="hidden" name="anio" value="{{ anio }}">

  <div class="form-grid">
    <div class="form-col">
      <label for="{{ form.fecha.id_for_label }}">Fecha</label>
      {{ form.fecha }}

      <label for="{{ form.cliente.id_for_label }}">Cliente</label>
      {{ form.cliente|default_if_none:"" }}

      <label for="id_comision_porcentaje_display">Comisión (%)</label>
      <input
        type="text"
        id="id_comision_porcentaje_display"
        value="{% if form.instance and form.instance.comision_porcentaje %}{{ form.instance.comision_porcentaje|floatformat:2 }}%{% else %}0.00%{% endif %}"
        readonly />

      <label for="{{ form.comentarios.id_for_label }}">Comentarios</label>
      {{ form.comentarios|default_if_none:"" }}
    </div>

    <div class="form-col">
      <label for="{{ form.monto_venta.id_for_label }}">Monto venta</label>
      <div class="input-currency">{{ form.monto_venta|default_if_none:"" }}</div>

      <label for="{{ form.facturadora.id_for_label }}">Facturadora</label>
      {{ form.facturadora|default_if_none:"" }}

      <label for="{{ form.num_factura.id_for_label }}">No. factura</label>
      {{ form.num_factura|default_if_none:"" }}

      <label for="{{ form.fecha_pago.id_for_label }}">Fecha pago</label>
      {{ form.fecha_pago|default_if_none:"" }}

      <label for="{{ form.fecha_vigencia.id_for_label }}">Fecha vigencia</label>
      {{ form.fecha_vigencia|default_if_none:"" }}

      <label for="{{ form.fecha_arranque.id_for_label }}">Fecha arranque</label>
      {{ form.fecha_arranque|default_if_none:"" }}

      <label for="{{ form.estatus_pago.id_for_label }}">Estatus pago</label>
      {{ form.estatus_pago|default_if_none:"" }}
    </div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const clienteSelect = document.getElementById('{{ form.cliente.id_for_label }}');
      const display = document.getElementById('id_comision_porcentaje_display');
      if (!clienteSelect || !display) return;

      const normalizePercent = (rate) => {
        if (Number.isNaN(rate)) return 0;
        return rate <= 1 ? rate * 100 : rate;
      };

      const updateDisplay = () => {
        const option = clienteSelect.options[clienteSelect.selectedIndex];
        const raw = option ? option.getAttribute('data-comision') : '';
        const rate = raw ? parseFloat(String(raw).replace(',', '.')) : 0;
        const percent = normalizePercent(rate);
        display.value = `${percent.toFixed(2)}%`;
      };

      clienteSelect.addEventListener('change', updateDisplay);
      updateDisplay();
    });
  </script>
{% endblock %}

{% block extra_actions %}
  {% if venta %}
    <button type="submit"
            class="btn-delete"
            formaction="{% url 'ventas_venta_delete' venta.id %}"
            formmethod="post"
            onclick="return confirm('¿Eliminar esta venta?');">
      Eliminar
    </button>
  {% endif %}
{% endblock %}
