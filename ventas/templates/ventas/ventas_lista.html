{% extends "lista.html" %}
{% load ventas_extras %}

{% block title %}Ventas{% endblock %}

{% block filtros_left %}
  <a href="{% url 'ventas_venta_dashboard' %}?mes={{ mes }}&anio={{ anio }}" class="btn-filter">Dashboard</a>
{% endblock %}

{% block filtros %}
  <div class="ventas-filter-center">
    <div class="filter-title">{{ mes_nombre }} {{ anio }}</div>
    <form action="{% url 'ventas_venta_list' %}" method="get" class="filter-form-simple dispersiones-filter">
      <div class="filter-stack">
        <label for="mes">Mes</label>
        <select id="mes" name="mes">
          {% if meses_choices %}
            {% for m, nombre in meses_choices %}
              <option value="{{ m }}" {% if mes == m|stringformat:'i' %}selected{% endif %}>{{ nombre }}</option>
            {% endfor %}
          {% else %}
            {% for m in meses %}
              <option value="{{ m }}" {% if mes == m|stringformat:'i' %}selected{% endif %}>{{ m|stringformat:"02d" }}</option>
            {% endfor %}
          {% endif %}
        </select>
      </div>

      <div class="filter-stack">
        <label for="anio">Año</label>
        <input type="number" id="anio" name="anio" value="{{ anio }}" min="2000" max="2100">
      </div>

      <div class="filter-stack">
        <label for="estatus_pago">Estatus de pago</label>
        <select id="estatus_pago" name="estatus_pago">
          <option value="">Todos</option>
          {% for val, label in estatus_pago_choices %}
            <option value="{{ val }}" {% if estatus_pago == val %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <button type="submit" class="btn-filter">Filtrar</button>
    </form>
  </div>
{% endblock %}

{% block filtros_right %}
  <a href="{% url 'ventas_venta_create' %}?mes={{ mes }}&anio={{ anio }}&next={{ request.get_full_path|urlencode }}" class="btn-primary btn-primary-inline">Nueva venta</a>
{% endblock %}

{% block tabla_head %}
  <tr>
    <th class="sticky-1 col-actions">Acciones</th>
    <th class="sticky-2 col-fecha">Fecha</th>
    <th class="sticky-3">Cliente</th>
    <th>Servicio</th>
    <th>Facturadora</th>
    <th>No. factura</th>
    <th>Monto venta</th>
    <th>Comisión (%)</th>
    <th>Fecha pago</th>
    <th>Fecha vigencia</th>
    <th>Fecha arranque</th>
    <th>Estatus pago</th>
    <th>Comentarios</th>
  </tr>
{% endblock %}

{% block tabla_body %}
  {% for d in ventas %}
    <tr>
      <td class="sticky-1 col-actions"><a class="btn-detalle" href="{% url 'ventas_venta_update' d.id %}?mes={{ mes }}&anio={{ anio }}&next={{ request.get_full_path|urlencode }}">Editar</a></td>
      <td class="sticky-2 col-fecha">{{ d.fecha|date:"d/m/Y" }}</td>
      <td class="sticky-3">{{ d.cliente }}</td>
      <td>{{ d.servicio|default_if_none:"" }}</td>
      <td>{{ d.facturadora|default_if_none:"" }}</td>
      <td>{{ d.num_factura|default_if_none:"" }}</td>
      <td>{{ d.monto_venta|currency }}</td>
      <td>{{ d.comision_porcentaje|floatformat:2 }}%</td>
      <td>{{ d.fecha_pago|date:"d/m/Y"|default_if_none:"" }}</td>
      <td>{{ d.fecha_vigencia|date:"d/m/Y"|default_if_none:"" }}</td>
      <td>{{ d.fecha_arranque|date:"d/m/Y"|default_if_none:"" }}</td>
      <td>{{ d.estatus_pago }}</td>
      <td>{{ d.comentarios|default_if_none:"" }}</td>
    </tr>
  {% empty %}
    <tr><td colspan="13">Sin ventas en el periodo.</td></tr>
  {% endfor %}
{% endblock %}
