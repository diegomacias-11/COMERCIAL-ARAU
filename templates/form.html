{% extends "base.html" %}
{% load static %}

{% block title %}Formulario{% endblock %}

{% block content %}
  <main>
  {% block back_link %}{% endblock %}

  <div class="form-container {% block form_container_classes %}{% endblock %}">
    <form method="post" {% block form_attrs %}{% endblock %}>
      {% csrf_token %}
      {% block form_fields %}
        <!-- Aquí van los campos específicos del formulario hijo -->
        {% endblock %}
        <button type="submit" class="btn-submit">Guardar</button>
        {% block extra_actions %}{% endblock %}
      </form>
  </div>
  </main>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.querySelector('.form-container form');
      if (!form) return;

      form.addEventListener('submit', (ev) => {
        const submitter = ev.submitter || null;
        const deleteSubmit = submitter && submitter.classList && submitter.classList.contains('btn-delete');
        const skipSaveConfirm = form.dataset.skipSaveConfirm === '1';
        if (deleteSubmit || skipSaveConfirm) {
          form.dataset.skipSaveConfirm = '0';
          return;
        }

        const confirmMessage = form.getAttribute('data-confirm-message');
        const confirmFlag = (form.dataset.confirm || '').toLowerCase();
        const confirmEnabled = !(confirmFlag === '0' || confirmFlag === 'false' || confirmFlag === 'no');
        if (confirmEnabled) {
          if (form.dataset.confirmDone === '1') return;
          const ok = confirm(confirmMessage || '\u00bfGuardar cambios?');
          if (!ok) {
            ev.preventDefault();
            return;
          }
          form.dataset.confirmDone = '1';
        }
      });

      const deleteButtons = Array.from(document.querySelectorAll('.btn-delete'));
      deleteButtons.forEach((btn) => {
        // Mensaje global de eliminacion para todos los formularios.
        const deleteConfirmMessage = '\u00bfEliminar este registro?';

        // Centraliza la confirmacion de borrado y evita doble confirmacion.
        if (btn.hasAttribute('onclick')) {
          btn.removeAttribute('onclick');
        }
        btn.addEventListener('click', (ev) => {
          const ok = confirm(deleteConfirmMessage);
          if (!ok) {
            ev.preventDefault();
            return;
          }
          form.dataset.skipSaveConfirm = '1';
        });
      });

    });
  </script>
{% endblock %}

