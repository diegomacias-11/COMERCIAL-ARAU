{% extends "kanban_base.html" %}

{% block title %}Actividades (Kanban){% endblock %}

{% block filtros_left %}
  <a class="btn-primary btn-primary-inline btn-view" href="?vista=lista&cliente={{ cliente_sel }}">Vista</a>
{% endblock %}

{% block filtros %}
  <form method="get" class="filter-form-simple kanban-filter">
    <input type="hidden" name="vista" value="kanban">
    <div class="filter-block">
      <label for="cliente">Cliente</label>
      <select id="cliente" name="cliente">
        <option value="">Todos</option>
        {% for val,label in clientes_choices %}
          <option value="{{ val }}" {% if cliente_sel == val %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="filter-block">
      <label for="mercadologo">Mercad칩logo</label>
      <select id="mercadologo" name="mercadologo">
        <option value="">Todos</option>
        <option value="__none__" {% if mercadologo_sel == "__none__" %}selected{% endif %}>Sin asignar</option>
        {% for val,label in mercadologo_choices %}
          <option value="{{ val }}" {% if mercadologo_sel == val %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="filter-block">
      <label for="disenador">Dise침ador</label>
      <select id="disenador" name="disenador">
        <option value="">Todos</option>
        <option value="__none__" {% if disenador_sel == "__none__" %}selected{% endif %}>Sin asignar</option>
        {% for val,label in disenador_choices %}
          <option value="{{ val }}" {% if disenador_sel == val %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="filter-actions">
      <button type="submit" class="btn-filter">Filtrar</button>
      <a href="?vista=kanban" class="btn-filter">Limpiar</a>
    </div>
  </form>
{% endblock %}

{% block filtros_right %}
  <a href="{% url 'actividades_merca_actividad_create' %}?next={{ request.get_full_path|urlencode }}" class="btn-primary btn-primary-inline">Nueva actividad</a>
{% endblock %}

{% block avisos %}
  {% if show_unassigned_warning %}
    <div class="aviso aviso-warning">Hay actividades sin mercad칩logo o dise침ador asignado.</div>
  {% endif %}
{% endblock %}

{% block kanban_content %}
  <div class="kanban-board">
    {% for col in kanban_columns %}
      <div class="kanban-column {% if col.status_class %}{{ col.status_class }}{% endif %}">
        <div class="kanban-column-title kanban-column-title-citas">
          <button type="button" class="btn-filter btn-expand-toggle" data-target="col-{{ forloop.counter }}">Extender</button>
          <div class="kanban-column-name">{{ col.status }}</div>
          <div class="kanban-column-count">Total: {{ col.total }}</div>
        </div>
        <div class="kanban-column-body" id="col-{{ forloop.counter }}">
          {% for client in col.clients %}
            <div class="kanban-client">
              <button type="button"
                      class="kanban-client-title btn-client-toggle"
                      data-target="client-{{ forloop.parentloop.counter }}-{{ forloop.counter }}"
                      aria-expanded="false">
                <span class="kanban-client-name">{{ client.cliente }}</span>
                <span class="kanban-client-count">Total: {{ client.total }}</span>
              </button>
              <div class="kanban-client-body is-collapsed" id="client-{{ forloop.parentloop.counter }}-{{ forloop.counter }}">
              {% for area in client.areas %}
                <div class="kanban-area">
                  <div class="kanban-area-title">
                    <span>{{ area.nombre }}</span>
                    <span class="kanban-area-count">({{ area.count }})</span>
                  </div>
                  {% if area.items %}
                    {% for act in area.items %}
                      <div class="kanban-card">
                        <div class="kanban-card-header">
                          <div class="kanban-card-date">{{ act.fecha_inicio|date:"d/m/Y" }}</div>
                          <a href="{% url 'actividades_merca_actividad_update' act.id %}?next={{ request.get_full_path|urlencode }}" class="btn-detalle">Detalle</a>
                        </div>
                        <div class="kanban-card-days">{{ act.dias_label }}</div>
                        <div class="kanban-task">{{ act.tarea }}</div>
                        <div class="kanban-meta">Responsable: {{ act.responsables }}</div>
                      </div>
                    {% endfor %}
                  {% else %}
                    <div class="kanban-empty">Sin tareas</div>
                  {% endif %}
                </div>
              {% endfor %}
              </div>
            </div>
          {% empty %}
            <div class="kanban-empty">Sin actividades</div>
          {% endfor %}
        </div>
      </div>
    {% empty %}
      <div class="kanban-empty">Sin actividades</div>
    {% endfor %}
  </div>
  <script>
    document.querySelectorAll('.btn-expand-toggle').forEach(function(btn) {
      btn.addEventListener('click', function() {
        var target = document.getElementById(btn.dataset.target);
        if (!target) return;
        // Solo controla subgrupos de cliente (no colapsa la columna)
        var clientBodies = target.querySelectorAll('.kanban-client-body');
        var clientToggles = target.querySelectorAll('.btn-client-toggle');
        var anyOpen = Array.from(clientBodies).some(function(body) {
          return !body.classList.contains('is-collapsed');
        });
        if (anyOpen) {
          clientBodies.forEach(function(body) { body.classList.add('is-collapsed'); });
          clientToggles.forEach(function(toggle) { toggle.setAttribute('aria-expanded', 'false'); });
          btn.textContent = 'Extender';
        } else {
          clientBodies.forEach(function(body) { body.classList.remove('is-collapsed'); });
          clientToggles.forEach(function(toggle) { toggle.setAttribute('aria-expanded', 'true'); });
          btn.textContent = 'Retraer';
        }
      });
    });
    document.querySelectorAll('.btn-client-toggle').forEach(function(btn) {
      btn.addEventListener('click', function() {
        var target = document.getElementById(btn.dataset.target);
        if (!target) return;
        var collapsed = target.classList.toggle('is-collapsed');
        btn.setAttribute('aria-expanded', String(!collapsed));
      });
    });
  </script>
{% endblock %}
